<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <style>
        canvas {
            border: 1px solid #000000;
            cursor: default;
        }

        input {
            width: 515px;
        }

        .left {
            float: left;
            width: 515px;
        }

        .right {
            margin-left: 515px;
        }

    </style>


    <script src="//code.jquery.com/jquery-2.1.4.js"></script>
    <script src="jcanvas.js"></script>
    <script src="jchessboard.js"></script>
    <script src="jchessengine.js"></script>

</head>
<body>
<div>
<div class="left">
    <canvas width="512" height="512">
    </canvas>
</div>
<div class="right">
    <div id="fen"></div>
</div>
<script>

    var problems = [
//            '1P6/2R5/n7/8/8/8/8/8 b -'
//        'n7/2P5/1Q6/8/8/8/8/8 b -'
//        '1P6/8/n7/2Q5/8/8/8/8 b -'
//        '1B6/8/n7/2N5/8/8/8/8 b -'
//        'k7/R7/n7/K7/8/8/8/8 b -'
//        'k7/1R6/nK6/8/8/8/8/8 w -',
//        'k7/1R6/n7/8/8/8/8/7K w -',
//        '7k/7b/5Kp1/8/8/8/8/5Q2 w -'
//        'k1b5/ppK5/5Q2/8/8/8/8/1R6 w -',
        'rnbqkbnr/ppppp1pp/8/5p2/4P3/8/PPPP1PPP/RNBQKBNR w KQkq'
    ];

    var canvas = $('canvas').jschessboard({numbers: true});
    var board = canvas.board;
    var eventDispatcher = board.eventDispatcher;

    eventDispatcher.addEventListener('board_post_piece_move', function (event) {
        console.log(event.subject.identificator, event.environment);
        $('#fen').val(board.positionToFen());
    });

    eventDispatcher.addEventListener('board_checkmate_detected', function (event) {
        alert('Checkmate');
    });

    eventDispatcher.addEventListener('board_pawn_promotion', function (event) {
        board.onPawnPromotion(event.subject, 'q');
    });

    var problem = parseInt(localStorage.getItem('problem'));
    if (problem < problems.length - 1) {
        problem += 1;
    } else {
        problem = 0;
    }
    localStorage.setItem('problem', problem);

    board.fenToPosition(problems[problem]);

    var engine = new JChessEngine(board, 'b');
    //    board.move(engine.think());

    eventDispatcher.addEventListener('board_post_piece_move', function (event) {
        $('#thinking').show();
        setTimeout(function () {

            if (engine.side !== event.subject.board.nextStepSide) {
                return;
            }
//            var san = engine.think();
//
//            if (san !== undefined) {
////                board.move(san);
//            } else {
//                alert('Game over');
//            }
//            $('#thinking').hide();
        }, 500);

    });

    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min)) + min;
    }

    $('#fen').val(board.positionToFen());

    $('#fen').keyup(function () {
        board.fenToPosition($('#fen').val());
    });

</script>

</body>
</html>
